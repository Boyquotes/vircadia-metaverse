version: '3.9'

services:
    # MongoDB service
    mongo_db:
        container_name: mongodb_container
        image: mongo:latest
        restart: always
        # ports:
        # - 27018:27017
        volumes:
            - mongo_db:/data/db
    redis:
        container_name: redis_container
        restart: always
        image: redis/redis-stack:latest
        # command: redis-server --save 20 1 --loglevel warning
        volumes:
            - redis_server:/data/redis
    # Node API service
    api:
        #container_name: vircadia-metaverse-v2
        build: .
        # ports:
        # - 3040:3040
        volumes:
            - .:/usr/src/api
        environment:
            PORT: 3040
            MONGODB_URL: mongodb://mongodb_container:27017
            REDIS_URL: redis://redis_container:6379
            NAME: Vircadia
        depends_on:
            - mongo_db
            - redis
    nginx:
        image: nginx:latest
        volumes:
            - ./conf.d:/etc/nginx/conf.d
        depends_on:
            - api
        ports:
            - 3040:3040
            - 443:443
            - 80:80

volumes:
    mongo_db: {}
    redis_server: {}


